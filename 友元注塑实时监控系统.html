<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注塑生产监控系统</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        /* 样式保持不变 */
        :root {
            --primary: #2196F3;
            --primary-dark: #1976D2;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #F44336;
            --dark: #333;
            --light: #f5f5f5;
            --gray: #757575;
            --border: #e0e0e0;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .current-tasks-panel {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .machine-panel {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            height: fit-content;
        }
        
        .machine-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .machine-card {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background-color: white;
        }
        
        .machine-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .machine-card.active {
            border-color: var(--primary);
            background-color: rgba(33, 150, 243, 0.05);
        }
        
        .machine-id {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .machine-details {
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }
        
        .machine-status {
            font-size: 14px;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
            font-weight: bold;
        }
        
        .status-idle {
            background-color: #e0e0e0;
            color: var(--gray);
        }
        
        .status-running {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }
        
        .status-paused {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }
        
        .status-warning {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }
        
        .status-error {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger);
        }
        
        .task-panel {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        .task-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .trial-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .tasks-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .tasks-table th, .tasks-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .tasks-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #555;
        }
        
        .tasks-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .tasks-table tr.urgent {
            background-color: #fff9c4;
        }
        
        .tasks-table tr.urgent:hover {
            background-color: #fff59d;
        }
        
        .progress-container {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--success);
            transition: width 0.3s;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }
        
        .close-btn:hover {
            color: var(--danger);
        }
        
        .statistics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-idle { color: var(--gray); }
        .stat-running { color: var(--success); }
        .stat-warning { color: var(--warning); }
        .stat-error { color: var(--danger); }
        
        .urgent-badge {
            background-color: var(--warning);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
            font-weight: bold;
        }
        
        .tab:hover:not(.active) {
            background-color: #f5f5f5;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .machine-edit-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            font-size: 14px;
            padding: 5px;
            transition: color 0.3s;
        }
        
        .machine-edit-btn:hover {
            color: var(--primary);
        }
        
        .excess-production {
            color: var(--warning);
            font-weight: bold;
        }
        
        .current-time {
            font-size: 16px;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .no-tasks {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-style: italic;
        }
        
        .form-hint {
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }
        
        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        
        .alert-success {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
            border: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .alert-error {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger);
            border: 1px solid rgba(244, 67, 54, 0.2);
        }
        
        .form-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .form-section-title {
            font-size: 18px;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .completed-qty-input {
            width: 80px;
            padding: 5px;
            border: 1px solid var(--border);
            border-radius: 4px;
        }
        
        .completed-qty-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }
        
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .machine-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .machine-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .task-form, .trial-form {
                grid-template-columns: 1fr;
            }
            
            .statistics {
                grid-template-columns: repeat(2, 1fr);
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .header-actions {
                margin-top: 15px;
                width: 100%;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .tasks-table {
                font-size: 12px;
            }
            
            .tasks-table th, .tasks-table td {
                padding: 8px 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .machine-grid {
                grid-template-columns: 1fr;
            }
            
            .statistics {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>注塑生产监控系统</h1>
                <p>实时监控注塑机生产状态</p>
                <div class="current-time" id="current-time"></div>
            </div>
            <div class="header-actions">
                <button id="export-btn" class="btn-success">导出Excel报表</button>
                <button id="add-machine-btn" class="btn-primary">新增机台</button>
            </div>
        </header>
        
        <div class="alert alert-success" id="success-alert"></div>
        <div class="alert alert-error" id="error-alert"></div>
        
        <div class="statistics">
            <div class="stat-card">
                <div>空闲机台</div>
                <div class="stat-value stat-idle" id="idle-count">0</div>
                <div>台</div>
            </div>
            <div class="stat-card">
                <div>生产中</div>
                <div class="stat-value stat-running" id="running-count">0</div>
                <div>台</div>
            </div>
            <div class="stat-card">
                <div>试模中</div>
                <div class="stat-value stat-warning" id="trial-count">0</div>
                <div>台</div>
            </div>
            <div class="stat-card">
                <div>故障中</div>
                <div class="stat-value stat-error" id="error-count">0</div>
                <div>台</div>
            </div>
        </div>
        
        <!-- 当前任务栏移到上方 -->
        <div class="current-tasks-panel">
            <h2>当前任务</h2>
            <table class="tasks-table">
                <thead>
                    <tr>
                        <th>类型</th>
                        <th>机台号</th>
                        <th>模具/模号</th>
                        <th>目标数量</th>
                        <th>已完成</th>
                        <th>超产数量</th>
                        <th>进度</th>
                        <th>预计完成</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="current-tasks-table-body">
                    <!-- 当前任务数据将通过JavaScript动态生成 -->
                </tbody>
            </table>
            <div class="no-tasks" id="no-current-tasks" style="display: none;">暂无任务</div>
        </div>
        
        <div class="dashboard">
            <div class="machine-panel">
                <h2>注塑机状态</h2>
                <div class="machine-grid" id="machine-grid">
                    <!-- 机台卡片将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="task-panel">
                <div class="tab-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="production">生产任务</div>
                        <div class="tab" data-tab="trial">试模任务</div>
                    </div>
                    
                    <div class="tab-content active" id="production-tab">
                        <h2>生产任务管理</h2>
                        <div class="task-form" id="task-form">
                            <div class="form-group">
                                <label for="machine-id">机台号</label>
                                <select id="machine-id" required>
                                    <option value="">请选择机台</option>
                                    <!-- 选项将通过JavaScript动态生成 -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="mold-no">模具编号</label>
                                <input type="text" id="mold-no" required>
                            </div>
                            <div class="form-group">
                                <label for="cycle-time">生产周期 (秒/件)</label>
                                <input type="number" id="cycle-time" min="1" required>
                                <div class="form-hint">生产一件产品所需的时间(秒)</div>
                            </div>
                            <div class="form-group">
                                <label for="order-qty">订单数量</label>
                                <input type="number" id="order-qty" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="stock-qty">库存数量</label>
                                <input type="number" id="stock-qty" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="required-qty">需生产数量</label>
                                <input type="number" id="required-qty" min="1" required>
                                <div class="form-hint">根据订单数量和库存数量自动计算，可手动调整</div>
                            </div>
                            <div class="form-group">
                                <label for="start-time">开始时间</label>
                                <input type="datetime-local" id="start-time" required>
                            </div>
                            <div class="form-group">
                                <label for="color">颜色</label>
                                <input type="text" id="color">
                            </div>
                            <div class="form-group">
                                <label for="production-method">生产方式</label>
                                <select id="production-method">
                                    <option value="自动">自动</option>
                                    <option value="半自动">半自动</option>
                                    <option value="手动">手动</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label for="remark">备注</label>
                                <textarea id="remark"></textarea>
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <button id="add-task-btn" class="btn-primary">添加生产任务</button>
                            <button id="update-task-btn" class="btn-success" style="display: none;">更新生产任务</button>
                            <button id="reset-form-btn" class="btn-secondary">重置表单</button>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="trial-tab">
                        <h2>试模任务管理</h2>
                        <div class="trial-form" id="trial-form">
                            <div class="form-group">
                                <label for="trial-machine-id">机台号</label>
                                <select id="trial-machine-id" required>
                                    <option value="">请选择机台</option>
                                    <!-- 选项将通过JavaScript动态生成 -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="trial-mold-no">模号</label>
                                <input type="text" id="trial-mold-no" required>
                            </div>
                            <div class="form-group">
                                <label for="customer-mold-no">客户模号</label>
                                <input type="text" id="customer-mold-no" required>
                            </div>
                            <div class="form-group">
                                <label for="trial-color">颜色</label>
                                <input type="text" id="trial-color">
                            </div>
                            <div class="form-group">
                                <label for="material">胶料</label>
                                <input type="text" id="material" required>
                            </div>
                            <div class="form-group">
                                <label for="trial-qty">试模数量</label>
                                <input type="number" id="trial-qty" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="applicant">申请人</label>
                                <input type="text" id="applicant" required>
                            </div>
                            <div class="form-group">
                                <label for="trial-start-time">开始时间</label>
                                <input type="datetime-local" id="trial-start-time" required>
                            </div>
                            <div class="form-group full-width">
                                <label for="trial-remark">备注</label>
                                <textarea id="trial-remark"></textarea>
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <button id="add-trial-btn" class="btn-primary">添加试模任务</button>
                            <button id="update-trial-btn" class="btn-success" style="display: none;">更新试模任务</button>
                            <button id="reset-trial-btn" class="btn-secondary">重置表单</button>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin-top: 30px;">所有任务</h3>
                <table class="tasks-table">
                    <thead>
                        <tr>
                            <th>类型</th>
                            <th>机台号</th>
                            <th>模具/模号</th>
                            <th>目标数量</th>
                            <th>已完成</th>
                            <th>超产数量</th>
                            <th>进度</th>
                            <th>预计完成</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="tasks-table-body">
                        <!-- 所有任务数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
                <div class="no-tasks" id="no-tasks" style="display: none;">暂无任务</div>
            </div>
        </div>
    </div>
    
    <!-- 更新生产进度模态框 -->
    <div class="modal" id="update-progress-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>更新生产进度</h2>
                <button class="close-btn" id="close-progress-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="completed-qty">已完成数量</label>
                <input type="number" id="completed-qty" min="0">
            </div>
            <div class="form-group">
                <label for="machine-status">机台状态</label>
                <select id="machine-status">
                    <option value="running">生产中</option>
                    <option value="paused">已暂停</option>
                    <option value="idle">空闲</option>
                    <option value="warning">待机</option>
                    <option value="error">故障</option>
                </select>
            </div>
            <div class="btn-group">
                <button id="save-progress-btn" class="btn-success">保存</button>
                <button id="cancel-progress-btn" class="btn-secondary">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑机台信息模态框 -->
    <div class="modal" id="edit-machine-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>编辑机台信息</h2>
                <button class="close-btn" id="close-machine-modal">&times;</button>
            </div>
            <div class="task-form">
                <div class="form-group">
                    <label for="edit-machine-name">机台名称</label>
                    <input type="text" id="edit-machine-name">
                </div>
                <div class="form-group">
                    <label for="edit-machine-brand">品牌</label>
                    <input type="text" id="edit-machine-brand">
                </div>
                <div class="form-group">
                    <label for="edit-machine-tonnage">吨位数</label>
                    <input type="number" id="edit-machine-tonnage" min="1">
                </div>
                <div class="form-group">
                    <label for="edit-machine-mold-size">容模尺寸</label>
                    <input type="text" id="edit-machine-mold-size" placeholder="例如: 400x400x400mm">
                </div>
                <div class="form-group">
                    <label for="edit-machine-shot-weight">熔胶量</label>
                    <input type="number" id="edit-machine-shot-weight" min="1" placeholder="单位: g">
                </div>
                <div class="form-group">
                    <label for="edit-machine-status">机台状态</label>
                    <select id="edit-machine-status">
                        <option value="idle">空闲</option>
                        <option value="running">生产中</option>
                        <option value="paused">已暂停</option>
                        <option value="warning">待机</option>
                        <option value="error">故障</option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label for="edit-machine-remark">备注</label>
                    <textarea id="edit-machine-remark"></textarea>
                </div>
            </div>
            <div class="btn-group">
                <button id="save-machine-btn" class="btn-success">保存</button>
                <button id="cancel-machine-btn" class="btn-secondary">取消</button>
                <button id="delete-machine-btn" class="btn-danger">删除机台</button>
            </div>
        </div>
    </div>
    
    <!-- 新增机台模态框 -->
    <div class="modal" id="add-machine-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>新增机台</h2>
                <button class="close-btn" id="close-add-machine-modal">&times;</button>
            </div>
            <div class="task-form">
                <div class="form-group">
                    <label for="new-machine-name">机台名称</label>
                    <input type="text" id="new-machine-name" placeholder="例如: 注塑机 15">
                </div>
                <div class="form-group">
                    <label for="new-machine-brand">品牌</label>
                    <input type="text" id="new-machine-brand">
                </div>
                <div class="form-group">
                    <label for="new-machine-tonnage">吨位数</label>
                    <input type="number" id="new-machine-tonnage" min="1">
                </div>
                <div class="form-group">
                    <label for="new-machine-mold-size">容模尺寸</label>
                    <input type="text" id="new-machine-mold-size" placeholder="例如: 400x400x400mm">
                </div>
                <div class="form-group">
                    <label for="new-machine-shot-weight">熔胶量</label>
                    <input type="number" id="new-machine-shot-weight" min="1" placeholder="单位: g">
                </div>
                <div class="form-group full-width">
                    <label for="new-machine-remark">备注</label>
                    <textarea id="new-machine-remark"></textarea>
                </div>
            </div>
            <div class="btn-group">
                <button id="save-new-machine-btn" class="btn-success">保存</button>
                <button id="cancel-new-machine-btn" class="btn-secondary">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 结束任务模态框 -->
    <div class="modal" id="end-task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="end-task-title">结束任务</h2>
                <button class="close-btn" id="close-end-task-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="end-time">结束时间</label>
                <input type="datetime-local" id="end-time" required>
            </div>
            <div class="form-group" id="final-qty-container" style="display: none;">
                <label for="final-completed-qty">最终完成数量</label>
                <input type="number" id="final-completed-qty" min="0">
                <div class="form-hint">根据结束时间自动计算，可手动调整</div>
            </div>
            <div class="btn-group">
                <button id="save-end-task-btn" class="btn-success">确认结束</button>
                <button id="cancel-end-task-btn" class="btn-secondary">取消</button>
            </div>
        </div>
    </div>

    <script>
        // 初始化数据
        let machines = [];
        let tasks = [];
        let selectedMachineId = null;
        let editingTaskId = null;
        let progressUpdateTaskId = null;
        let autoUpdateInterval = null;
        let editingMachineId = null;
        let currentTab = 'production';
        let endingTaskId = null;
        let endingTaskType = null;
        
        // 初始化函数
        function init() {
            // 使用您提供的注塑机数据初始化14台注塑机
            const machineData = [
                { id: 1, name: "注塑机1", brand: "注友", tonnage: 300, moldSize: "680x680", shotWeight: 780 },
                { id: 2, name: "注塑机2", brand: "宁塑", tonnage: 200, moldSize: "530x530", shotWeight: 490 },
                { id: 3, name: "注塑机3", brand: "伊之密", tonnage: 200, moldSize: "620x510", shotWeight: 518 },
                { id: 4, name: "注塑机4", brand: "伊之密", tonnage: 200, moldSize: "620x510", shotWeight: 518 },
                { id: 5, name: "注塑机5", brand: "伊之密", tonnage: 160, moldSize: "560x460", shotWeight: 370 },
                { id: 6, name: "注塑机6", brand: "注友", tonnage: 160, moldSize: "460x460", shotWeight: 400 },
                { id: 7, name: "注塑机7", brand: "宁塑", tonnage: 140, moldSize: "450x450", shotWeight: 193 },
                { id: 8, name: "注塑机8", brand: "注友", tonnage: 130, moldSize: "480x410", shotWeight: 254 },
                { id: 9, name: "注塑机9", brand: "注友", tonnage: 120, moldSize: "430x410", shotWeight: 220 },
                { id: 10, name: "注塑机10", brand: "注友", tonnage: 90, moldSize: "380x360", shotWeight: 153 },
                { id: 11, name: "注塑机11", brand: "伊之密", tonnage: 450, moldSize: "880x780", shotWeight: 1859 },
                { id: 12, name: "注塑机12", brand: "海天", tonnage: 650, moldSize: "900x900", shotWeight: 2576 },
                { id: 13, name: "注塑机13", brand: "伊之密", tonnage: 320, moldSize: "760x670", shotWeight: 978 },
                { id: 14, name: "注塑机14", brand: "伊之密", tonnage: 1400, moldSize: "1600x1450", shotWeight: 5221 }
            ];
            
            machineData.forEach(data => {
                machines.push({
                    id: data.id,
                    name: data.name,
                    brand: data.brand,
                    tonnage: data.tonnage,
                    moldSize: data.moldSize,
                    shotWeight: data.shotWeight,
                    status: 'idle', // idle, running, paused, warning, error, trial
                    currentTask: null,
                    history: [],
                    remark: ''
                });
            });
            
            // 从本地存储加载数据
            loadData();
            
            // 渲染机台面板
            renderMachinePanel();
            
            // 渲染任务表单中的机台选项
            renderMachineOptions();
            
            // 渲染任务表格
            renderTasksTable();
            
            // 更新统计信息
            updateStatistics();
            
            // 设置当前时间
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // 设置事件监听器
            setupEventListeners();
            
            // 启动自动更新进度
            startAutoUpdate();
        }
        
        // 从本地存储加载数据
        function loadData() {
            const savedMachines = localStorage.getItem('injectionMoldingMachines');
            const savedTasks = localStorage.getItem('injectionMoldingTasks');
            
            if (savedMachines) {
                // 如果本地存储中有机器数据，合并基本信息
                const parsedMachines = JSON.parse(savedMachines);
                
                machines.forEach(machine => {
                    const savedMachine = parsedMachines.find(m => m.id === machine.id);
                    if (savedMachine) {
                        // 保留状态、当前任务、历史和备注
                        machine.status = savedMachine.status || 'idle';
                        machine.currentTask = savedMachine.currentTask || null;
                        machine.history = savedMachine.history || [];
                        machine.remark = savedMachine.remark || '';
                    }
                });
            }
            
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            }
        }
        
        // 保存数据到本地存储
        function saveData() {
            localStorage.setItem('injectionMoldingMachines', JSON.stringify(machines));
            localStorage.setItem('injectionMoldingTasks', JSON.stringify(tasks));
        }
        
        // 渲染机台面板
        function renderMachinePanel() {
            const machineGrid = document.getElementById('machine-grid');
            machineGrid.innerHTML = '';
            
            machines.forEach(machine => {
                const machineCard = document.createElement('div');
                machineCard.className = `machine-card ${selectedMachineId === machine.id ? 'active' : ''}`;
                machineCard.dataset.id = machine.id;
                
                let statusText = '';
                let statusClass = '';
                
                switch (machine.status) {
                    case 'idle':
                        statusText = '空闲';
                        statusClass = 'status-idle';
                        break;
                    case 'running':
                        statusText = '生产中';
                        statusClass = 'status-running';
                        break;
                    case 'paused':
                        statusText = '已暂停';
                        statusClass = 'status-paused';
                        break;
                    case 'trial':
                        statusText = '试模中';
                        statusClass = 'status-warning';
                        break;
                    case 'warning':
                        statusText = '待机';
                        statusClass = 'status-warning';
                        break;
                    case 'error':
                        statusText = '故障';
                        statusClass = 'status-error';
                        break;
                }
                
                machineCard.innerHTML = `
                    <div class="machine-id">${machine.name}</div>
                    <div class="machine-status ${statusClass}">${statusText}</div>
                    <div class="machine-details">
                        ${machine.brand} | ${machine.tonnage}T | ${machine.moldSize} | ${machine.shotWeight}g
                    </div>
                    ${machine.currentTask ? `<div style="margin-top: 8px; font-size: 14px;">${machine.currentTask.type === 'trial' ? '试模' : '生产'}: ${machine.currentTask.moldNo || machine.currentTask.trialMoldNo}</div>` : ''}
                    <button class="machine-edit-btn" data-id="${machine.id}">编辑</button>
                `;
                
                machineGrid.appendChild(machineCard);
            });
        }
        
        // 渲染机台选项
        function renderMachineOptions() {
            const machineSelect = document.getElementById('machine-id');
            const trialMachineSelect = document.getElementById('trial-machine-id');
            
            machineSelect.innerHTML = '<option value="">请选择机台</option>';
            trialMachineSelect.innerHTML = '<option value="">请选择机台</option>';
            
            machines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                option.textContent = machine.name;
                machineSelect.appendChild(option);
                
                const trialOption = document.createElement('option');
                trialOption.value = machine.id;
                trialOption.textContent = machine.name;
                trialMachineSelect.appendChild(trialOption);
            });
        }
        
        // 渲染任务表格
        function renderTasksTable() {
            const currentTableBody = document.getElementById('current-tasks-table-body');
            const allTableBody = document.getElementById('tasks-table-body');
            const noCurrentTasks = document.getElementById('no-current-tasks');
            const noTasks = document.getElementById('no-tasks');
            
            // 过滤当前任务（未完成的任务）
            const currentTasks = tasks.filter(task => task.status !== 'completed');
            
            // 渲染当前任务表格
            if (currentTasks.length === 0) {
                currentTableBody.innerHTML = '';
                noCurrentTasks.style.display = 'block';
            } else {
                noCurrentTasks.style.display = 'none';
                currentTableBody.innerHTML = '';
                currentTasks.forEach(task => renderTaskRow(task, currentTableBody));
            }
            
            // 渲染所有任务表格
            if (tasks.length === 0) {
                allTableBody.innerHTML = '';
                noTasks.style.display = 'block';
            } else {
                noTasks.style.display = 'none';
                allTableBody.innerHTML = '';
                tasks.forEach(task => renderTaskRow(task, allTableBody));
            }
            
            // 更新统计信息
            updateStatistics();
        }
        
        // 渲染单个任务行
        function renderTaskRow(task, tableBody) {
            const row = document.createElement('tr');
            
            // 计算超产数量
            const excessQty = task.completedQty > task.requiredQty ? task.completedQty - task.requiredQty : 0;
            
            // 计算进度百分比
            const progress = task.completedQty / (task.requiredQty || task.trialQty) * 100;
            
            // 计算预计完成时间
            let estimatedCompletion = '--';
            let isUrgent = false;
            
            if (task.type === 'production' && task.startTime && task.cycleTime) {
                const startTime = new Date(task.startTime);
                const currentTime = new Date();
                
                // 计算实际运行时间（排除暂停时间）
                let elapsedTime = currentTime - startTime;
                if (task.pausedAt) {
                    elapsedTime -= (currentTime - new Date(task.pausedAt));
                }
                
                const completedTime = elapsedTime / 1000; // 转换为秒
                
                // 计算实际完成数量（基于时间流逝）
                const actualCompleted = Math.floor(completedTime / task.cycleTime);
                
                // 如果任务状态为运行中，且没有手动更新过，自动更新完成数量
                if (task.status === 'running' && actualCompleted > task.completedQty && !task.manuallyUpdated) {
                    task.completedQty = actualCompleted;
                    
                    // 如果任务完成，更新状态
                    if (task.completedQty >= task.requiredQty && !task.completedAt) {
                        task.status = 'completed';
                        const machine = machines.find(m => m.id === task.machineId);
                        if (machine) {
                            machine.status = 'idle';
                            // 添加到历史记录
                            machine.history.push({
                                type: 'production',
                                taskId: task.id,
                                startTime: task.startTime,
                                endTime: new Date().toISOString(),
                                moldNo: task.moldNo,
                                completedQty: task.completedQty,
                                requiredQty: task.requiredQty,
                                excessQty: excessQty
                            });
                            machine.currentTask = null;
                        }
                        task.completedAt = new Date().toISOString();
                    }
                    
                    saveData();
                }
                
                // 重新计算预计完成时间
                if (task.status === 'running' || task.status === 'paused') {
                    const remainingQty = task.requiredQty - task.completedQty;
                    const remainingTime = remainingQty * task.cycleTime * 1000; // 转为毫秒
                    
                    // 如果任务暂停，使用暂停时间计算，否则使用当前时间
                    const baseTime = task.status === 'paused' ? new Date(task.pausedAt) : new Date();
                    const completionTime = new Date(baseTime.getTime() + remainingTime);
                    estimatedCompletion = formatDateTime(completionTime);
                    
                    // 检查是否即将完成（1小时内）
                    if (remainingTime <= 3600000) { // 1小时 = 3600000毫秒
                        isUrgent = true;
                    }
                } else if (task.status === 'completed' && task.completedAt) {
                    estimatedCompletion = formatDateTime(new Date(task.completedAt));
                }
            } else if (task.type === 'trial') {
                if (task.completedAt) {
                    estimatedCompletion = formatDateTime(new Date(task.completedAt));
                } else {
                    estimatedCompletion = '--';
                }
            }
            
            // 添加紧急提醒类
            if (isUrgent && (task.status === 'running' || task.status === 'paused')) {
                row.className = 'urgent';
            }
            
            // 生成操作按钮
            let actionButtons = '';
            if (task.status !== 'completed') {
                if (task.status === 'paused') {
                    actionButtons += `<button class="btn-success action-btn resume-task" data-id="${task.id}" data-type="${task.type}">继续</button>`;
                } else {
                    actionButtons += `<button class="btn-warning action-btn pause-task" data-id="${task.id}" data-type="${task.type}">暂停</button>`;
                }
                
                actionButtons += `<button class="btn-danger action-btn end-task" data-id="${task.id}" data-type="${task.type}">${task.type === 'production' ? '结束生产' : '结束试模'}</button>`;
            }
            
            actionButtons += `
                <button class="btn-primary action-btn edit-task" data-id="${task.id}" data-type="${task.type}">编辑</button>
                <button class="btn-warning action-btn update-progress" data-id="${task.id}" data-type="${task.type}">更新进度</button>
                <button class="btn-danger action-btn delete-task" data-id="${task.id}">删除</button>
            `;
            
            row.innerHTML = `
                <td>${task.type === 'production' ? '生产' : '试模'}</td>
                <td>${task.machineName} ${isUrgent && (task.status === 'running' || task.status === 'paused') ? '<span class="urgent-badge">即将完成</span>' : ''}</td>
                <td>${task.type === 'production' ? task.moldNo : task.trialMoldNo}</td>
                <td>${task.type === 'production' ? task.requiredQty : task.trialQty}</td>
                <td>
                    <input type="number" class="completed-qty-input" data-task-id="${task.id}" value="${task.completedQty}" min="0" style="width: 80px;">
                </td>
                <td>${excessQty > 0 ? `<span class="excess-production">${excessQty}</span>` : 0}</td>
                <td>
                    <div>${progress.toFixed(1)}%</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${progress}%"></div>
                    </div>
                </td>
                <td>${estimatedCompletion}</td>
                <td>
                    <span class="machine-status ${getStatusClass(task.status)}">${getStatusText(task.status)}</span>
                </td>
                <td>
                    <div class="action-buttons">
                        ${actionButtons}
                    </div>
                </td>
            `;
            
            tableBody.appendChild(row);
        }
        
        // 更新统计信息
        function updateStatistics() {
            const idleCount = machines.filter(m => m.status === 'idle').length;
            const runningCount = machines.filter(m => m.status === 'running').length;
            const pausedCount = machines.filter(m => m.status === 'paused').length;
            const trialCount = machines.filter(m => m.status === 'trial').length;
            const errorCount = machines.filter(m => m.status === 'error').length;
            
            document.getElementById('idle-count').textContent = idleCount;
            document.getElementById('running-count').textContent = runningCount + pausedCount; // 将暂停的也计入生产中
            document.getElementById('trial-count').textContent = trialCount;
            document.getElementById('error-count').textContent = errorCount;
        }
        
        // 更新当前时间
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = formatDateTime(now);
        }
        
        // 设置事件监听器 - 修复版本
        function setupEventListeners() {
            // 机台卡片点击事件
            document.getElementById('machine-grid').addEventListener('click', function(e) {
                const machineCard = e.target.closest('.machine-card');
                if (machineCard) {
                    const machineId = parseInt(machineCard.dataset.id);
                    selectMachine(machineId);
                }
                
                // 编辑机台按钮
                const editBtn = e.target.closest('.machine-edit-btn');
                if (editBtn) {
                    const machineId = parseInt(editBtn.dataset.id);
                    openEditMachineModal(machineId);
                    e.stopPropagation(); // 防止触发机台选择
                }
            });
            
            // 标签页切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    switchTab(tabId);
                });
            });
            
            // 生产任务按钮
            document.getElementById('add-task-btn').addEventListener('click', addTask);
            document.getElementById('update-task-btn').addEventListener('click', updateTask);
            document.getElementById('reset-form-btn').addEventListener('click', resetForm);
            
            // 试模任务按钮
            document.getElementById('add-trial-btn').addEventListener('click', addTrialTask);
            document.getElementById('update-trial-btn').addEventListener('click', updateTrialTask);
            document.getElementById('reset-trial-btn').addEventListener('click', resetTrialForm);
            
            // 库存数量变化时自动计算需生产数量
            document.getElementById('order-qty').addEventListener('input', calculateRequiredQty);
            document.getElementById('stock-qty').addEventListener('input', calculateRequiredQty);
            
            // 任务表格操作按钮 - 修复：确保事件委托正确工作
            document.getElementById('current-tasks-table-body').addEventListener('click', function(e) {
                handleTaskAction(e);
            });
            
            document.getElementById('tasks-table-body').addEventListener('click', function(e) {
                handleTaskAction(e);
            });
            
            // 更新已完成数量输入框
            document.getElementById('current-tasks-table-body').addEventListener('change', function(e) {
                if (e.target.classList.contains('completed-qty-input')) {
                    const taskId = e.target.dataset.taskId;
                    const completedQty = parseInt(e.target.value);
                    updateTaskCompletedQty(taskId, completedQty);
                }
            });
            
            document.getElementById('tasks-table-body').addEventListener('change', function(e) {
                if (e.target.classList.contains('completed-qty-input')) {
                    const taskId = e.target.dataset.taskId;
                    const completedQty = parseInt(e.target.value);
                    updateTaskCompletedQty(taskId, completedQty);
                }
            });
            
            // 更新进度模态框事件
            document.getElementById('close-progress-modal').addEventListener('click', closeProgressModal);
            document.getElementById('cancel-progress-btn').addEventListener('click', closeProgressModal);
            document.getElementById('save-progress-btn').addEventListener('click', saveProgress);
            
            // 编辑机台模态框事件
            document.getElementById('close-machine-modal').addEventListener('click', closeEditMachineModal);
            document.getElementById('cancel-machine-btn').addEventListener('click', closeEditMachineModal);
            document.getElementById('save-machine-btn').addEventListener('click', saveMachine);
            document.getElementById('delete-machine-btn').addEventListener('click', deleteMachine);
            
            // 新增机台按钮和模态框
            document.getElementById('add-machine-btn').addEventListener('click', openAddMachineModal);
            document.getElementById('close-add-machine-modal').addEventListener('click', closeAddMachineModal);
            document.getElementById('cancel-new-machine-btn').addEventListener('click', closeAddMachineModal);
            document.getElementById('save-new-machine-btn').addEventListener('click', saveNewMachine);
            
            // 结束任务模态框事件
            document.getElementById('close-end-task-modal').addEventListener('click', closeEndTaskModal);
            document.getElementById('cancel-end-task-btn').addEventListener('click', closeEndTaskModal);
            document.getElementById('save-end-task-btn').addEventListener('click', saveEndTask);
            
            // 结束时间变化时更新生产数量
            document.getElementById('end-time').addEventListener('change', updateFinalCompletedQty);
            
            // 导出Excel按钮
            document.getElementById('export-btn').addEventListener('click', exportToExcel);
        }
        
        // 更新任务完成数量
        function updateTaskCompletedQty(taskId, completedQty) {
            const task = tasks.find(t => t.id === parseInt(taskId));
            if (task) {
                if (isNaN(completedQty) || completedQty < 0) {
                    alert('请输入有效的完成数量');
                    renderTasksTable(); // 重新渲染，恢复原来的值
                    return;
                }

                task.completedQty = completedQty;
                task.manuallyUpdated = true; // 标记为手动更新

                // 如果完成数量大于等于目标数量，自动完成任务
                if (task.completedQty >= (task.requiredQty || task.trialQty) && !task.completedAt) {
                    task.status = 'completed';
                    task.completedAt = new Date().toISOString();
                    const machine = machines.find(m => m.id === task.machineId);
                    if (machine) {
                        machine.status = 'idle';
                        // 添加到历史记录
                        machine.history.push({
                            type: task.type,
                            taskId: task.id,
                            startTime: task.startTime,
                            endTime: task.completedAt,
                            moldNo: task.moldNo || task.trialMoldNo,
                            completedQty: task.completedQty,
                            requiredQty: task.requiredQty || task.trialQty,
                            excessQty: task.completedQty > (task.requiredQty || task.trialQty) ? task.completedQty - (task.requiredQty || task.trialQty) : 0
                        });
                        machine.currentTask = null;
                    }
                }

                saveData();
                renderTasksTable(); // 重新渲染表格，更新进度条和超产数量
                updateStatistics();
            }
        }
        
        // 处理任务操作 - 修复版本
        function handleTaskAction(e) {
            // 确保我们点击的是按钮元素
            const button = e.target.closest('button');
            if (!button) return;
            
            console.log('点击了按钮:', button.className); // 调试信息
            
            if (button.classList.contains('edit-task')) {
                const taskId = button.dataset.id;
                const taskType = button.dataset.type;
                console.log('编辑任务:', taskId, taskType); // 调试信息
                editTask(taskId, taskType);
            } else if (button.classList.contains('update-progress')) {
                const taskId = button.dataset.id;
                const taskType = button.dataset.type;
                openProgressModal(taskId, taskType);
            } else if (button.classList.contains('pause-task')) {
                const taskId = button.dataset.id;
                const taskType = button.dataset.type;
                pauseTask(taskId, taskType);
            } else if (button.classList.contains('resume-task')) {
                const taskId = button.dataset.id;
                const taskType = button.dataset.type;
                resumeTask(taskId, taskType);
            } else if (button.classList.contains('end-task')) {
                const taskId = button.dataset.id;
                const taskType = button.dataset.type;
                openEndTaskModal(taskId, taskType);
            } else if (button.classList.contains('delete-task')) {
                const taskId = button.dataset.id;
                deleteTask(taskId);
            }
        }
        
        // 暂停任务
        function pauseTask(taskId, taskType) {
            const task = tasks.find(t => t.id === parseInt(taskId));
            if (task && task.status === 'running') {
                task.status = 'paused';
                task.pausedAt = new Date().toISOString();
                
                // 更新机台状态
                const machine = machines.find(m => m.id === task.machineId);
                machine.status = 'paused';
                
                saveData();
                renderTasksTable();
                renderMachinePanel();
                updateStatistics();
                
                alert('任务已暂停');
            }
        }
        
        // 继续任务
        function resumeTask(taskId, taskType) {
            const task = tasks.find(t => t.id === parseInt(taskId));
            if (task && task.status === 'paused') {
                task.status = 'running';
                
                // 调整开始时间以补偿暂停时间
                const pauseDuration = new Date() - new Date(task.pausedAt);
                const startTime = new Date(task.startTime);
                startTime.setTime(startTime.getTime() + pauseDuration);
                task.startTime = startTime.toISOString();
                
                task.pausedAt = null;
                
                // 更新机台状态
                const machine = machines.find(m => m.id === task.machineId);
                machine.status = 'running';
                
                saveData();
                renderTasksTable();
                renderMachinePanel();
                updateStatistics();
                
                alert('任务已继续');
            }
        }
        
        // 启动自动更新
        function startAutoUpdate() {
            // 每30秒自动更新一次进度
            autoUpdateInterval = setInterval(() => {
                renderTasksTable();
                renderMachinePanel();
            }, 30000);
        }
        
        // 选择机台
        function selectMachine(machineId) {
            selectedMachineId = machineId;
            renderMachinePanel();
            
            // 如果该机台有任务，填充表单
            const task = tasks.find(t => t.machineId === machineId);
            if (task) {
                if (task.type === 'production') {
                    switchTab('production');
                    fillFormWithTask(task);
                    document.getElementById('add-task-btn').style.display = 'none';
                    document.getElementById('update-task-btn').style.display = 'inline-block';
                } else {
                    switchTab('trial');
                    fillTrialFormWithTask(task);
                    document.getElementById('add-trial-btn').style.display = 'none';
                    document.getElementById('update-trial-btn').style.display = 'inline-block';
                }
                editingTaskId = task.id;
            } else {
                if (currentTab === 'production') {
                    resetForm();
                } else {
                    resetTrialForm();
                }
            }
        }
        
        // 切换标签页
        function switchTab(tabId) {
            currentTab = tabId;
            
            // 更新标签页样式
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            
            // 更新内容显示
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // 重置表单
            if (tabId === 'production') {
                resetForm();
            } else {
                resetTrialForm();
            }
        }
        
        // 填充生产任务表单
        function fillFormWithTask(task) {
            document.getElementById('machine-id').value = task.machineId;
            document.getElementById('mold-no').value = task.moldNo;
            document.getElementById('cycle-time').value = task.cycleTime;
            document.getElementById('order-qty').value = task.orderQty;
            document.getElementById('stock-qty').value = task.stockQty;
            document.getElementById('required-qty').value = task.requiredQty;
            document.getElementById('start-time').value = formatDateTimeInput(new Date(task.startTime));
            document.getElementById('color').value = task.color;
            document.getElementById('production-method').value = task.productionMethod;
            document.getElementById('remark').value = task.remark;
        }
        
        // 填充试模任务表单
        function fillTrialFormWithTask(task) {
            document.getElementById('trial-machine-id').value = task.machineId;
            document.getElementById('trial-mold-no').value = task.trialMoldNo;
            document.getElementById('customer-mold-no').value = task.customerMoldNo;
            document.getElementById('trial-color').value = task.trialColor;
            document.getElementById('material').value = task.material;
            document.getElementById('trial-qty').value = task.trialQty;
            document.getElementById('applicant').value = task.applicant;
            document.getElementById('trial-start-time').value = formatDateTimeInput(new Date(task.startTime));
            document.getElementById('trial-remark').value = task.trialRemark;
        }
        
        // 添加生产任务
        function addTask() {
            const formData = getFormData();
            
            if (!validateForm(formData)) {
                return;
            }
            
            // 检查机台是否已被占用
            const existingTask = tasks.find(t => t.machineId === formData.machineId);
            if (existingTask) {
                alert('该机台已有生产任务，请先删除或完成现有任务');
                return;
            }
            
            const task = {
                id: Date.now(), // 使用时间戳作为ID
                type: 'production',
                ...formData,
                machineName: machines.find(m => m.id === formData.machineId).name,
                completedQty: 0,
                status: 'running',
                createdAt: new Date().toISOString(),
                manuallyUpdated: false // 新增：标记是否手动更新过
            };
            
            tasks.push(task);
            
            // 更新机台状态
            const machine = machines.find(m => m.id === formData.machineId);
            machine.status = 'running';
            machine.currentTask = task.id;
            
            saveData();
            renderTasksTable();
            renderMachinePanel();
            updateStatistics();
            resetForm();
            
            alert('生产任务添加成功！');
        }
        
        // 更新生产任务 - 修复版本
        function updateTask() {
            if (!editingTaskId) return;
            
            const formData = getFormData();
            
            if (!validateForm(formData)) {
                return;
            }
            
            const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
            if (taskIndex === -1) return;
            
            // 检查是否更改了机台
            if (tasks[taskIndex].machineId !== formData.machineId) {
                // 释放原机台
                const oldMachine = machines.find(m => m.id === tasks[taskIndex].machineId);
                oldMachine.status = 'idle';
                oldMachine.currentTask = null;
                
                // 检查新机台是否可用
                const existingTask = tasks.find(t => t.machineId === formData.machineId && t.id !== editingTaskId);
                if (existingTask) {
                    alert('该机台已有生产任务，请选择其他机台');
                    return;
                }
                
                // 占用新机台
                const newMachine = machines.find(m => m.id === formData.machineId);
                newMachine.status = 'running';
                newMachine.currentTask = editingTaskId;
            }
            
            // 更新任务
            tasks[taskIndex] = {
                ...tasks[taskIndex],
                ...formData,
                machineName: machines.find(m => m.id === formData.machineId).name
            };
            
            saveData();
            renderTasksTable();
            renderMachinePanel();
            updateStatistics();
            resetForm();
            
            alert('生产任务更新成功！');
        }
        
        // 添加试模任务
        function addTrialTask() {
            const formData = getTrialFormData();
            
            if (!validateTrialForm(formData)) {
                return;
            }
            
            // 检查机台是否已被占用
            const existingTask = tasks.find(t => t.machineId === formData.machineId);
            if (existingTask) {
                alert('该机台已有任务，请先删除或完成现有任务');
                return;
            }
            
            const task = {
                id: Date.now(), // 使用时间戳作为ID
                type: 'trial',
                ...formData,
                machineName: machines.find(m => m.id === formData.machineId).name,
                completedQty: 0,
                status: 'trial',
                startTime: formData.trialStartTime,
                createdAt: new Date().toISOString(),
                manuallyUpdated: false // 新增：标记是否手动更新过
            };
            
            tasks.push(task);
            
            // 更新机台状态
            const machine = machines.find(m => m.id === formData.machineId);
            machine.status = 'trial';
            machine.currentTask = task.id;
            
            saveData();
            renderTasksTable();
            renderMachinePanel();
            updateStatistics();
            resetTrialForm();
            
            alert('试模任务添加成功！');
        }
        
        // 更新试模任务
        function updateTrialTask() {
            if (!editingTaskId) return;
            
            const formData = getTrialFormData();
            
            if (!validateTrialForm(formData)) {
                return;
            }
            
            const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
            if (taskIndex === -1) return;
            
            // 检查是否更改了机台
            if (tasks[taskIndex].machineId !== formData.machineId) {
                // 释放原机台
                const oldMachine = machines.find(m => m.id === tasks[taskIndex].machineId);
                oldMachine.status = 'idle';
                oldMachine.currentTask = null;
                
                // 检查新机台是否可用
                const existingTask = tasks.find(t => t.machineId === formData.machineId && t.id !== editingTaskId);
                if (existingTask) {
                    alert('该机台已有任务，请选择其他机台');
                    return;
                }
                
                // 占用新机台
                const newMachine = machines.find(m => m.id === formData.machineId);
                newMachine.status = 'trial';
                newMachine.currentTask = editingTaskId;
            }
            
            // 更新任务
            tasks[taskIndex] = {
                ...tasks[taskIndex],
                ...formData,
                machineName: machines.find(m => m.id === formData.machineId).name,
                startTime: formData.trialStartTime
            };
            
            saveData();
            renderTasksTable();
            renderMachinePanel();
            updateStatistics();
            resetTrialForm();
            
            alert('试模任务更新成功！');
        }
        
        // 打开结束任务模态框
        function openEndTaskModal(taskId, taskType) {
            const task = tasks.find(t => t.id === parseInt(taskId));
            if (task) {
                endingTaskId = taskId;
                endingTaskType = taskType;
                
                // 设置模态框标题
                document.getElementById('end-task-title').textContent = `结束${taskType === 'production' ? '生产' : '试模'}任务`;
                
                // 设置默认结束时间为当前时间
                const now = new Date();
                document.getElementById('end-time').value = formatDateTimeInput(now);
                
                // 如果是生产任务，显示最终数量输入框
                if (taskType === 'production') {
                    document.getElementById('final-qty-container').style.display = 'block';
                    updateFinalCompletedQty();
                } else {
                    document.getElementById('final-qty-container').style.display = 'none';
                }
                
                document.getElementById('end-task-modal').style.display = 'flex';
            }
        }
        
        // 更新最终完成数量
        function updateFinalCompletedQty() {
            if (endingTaskType !== 'production') return;
            
            const task = tasks.find(t => t.id === parseInt(endingTaskId));
            if (!task) return;
            
            const endTime = new Date(document.getElementById('end-time').value);
            const startTime = new Date(task.startTime);
            
            // 计算实际运行时间（秒）
            const elapsedTime = (endTime - startTime) / 1000;
            
            // 根据生产周期计算完成数量
            const calculatedQty = Math.floor(elapsedTime / task.cycleTime);
            
            // 设置最终完成数量
            document.getElementById('final-completed-qty').value = calculatedQty;
        }
        
        // 保存结束任务
        function saveEndTask() {
            const endTime = document.getElementById('end-time').value;
            
            if (!endTime) {
                alert('请选择结束时间');
                return;
            }
            
            const taskIndex = tasks.findIndex(t => t.id === parseInt(endingTaskId));
            if (taskIndex === -1) return;
            
            const task = tasks[taskIndex];
            const machine = machines.find(m => m.id === task.machineId);
            
            if (!machine) return;
            
            // 更新任务状态
            task.status = 'completed';
            task.completedAt = new Date(endTime).toISOString();
            
            // 如果是生产任务，更新完成数量
            if (endingTaskType === 'production') {
                const finalCompletedQty = parseInt(document.getElementById('final-completed-qty').value);
                if (isNaN(finalCompletedQty) || finalCompletedQty < 0) {
                    alert('请输入有效的完成数量');
                    return;
                }
                task.completedQty = finalCompletedQty;
            }
            
            // 计算超产数量
            const excessQty = task.type === 'production' && task.completedQty > task.requiredQty ? 
                task.completedQty - task.requiredQty : 0;
            
            // 添加到机台历史记录
            machine.history.push({
                type: task.type,
                taskId: task.id,
                startTime: task.startTime,
                endTime: task.completedAt,
                moldNo: task.moldNo || task.trialMoldNo,
                customerMoldNo: task.customerMoldNo,
                completedQty: task.completedQty,
                requiredQty: task.requiredQty || task.trialQty,
                excessQty: excessQty
            });
            
            // 释放机台
            machine.status = 'idle';
            machine.currentTask = null;
            
            saveData();
            renderTasksTable();
            renderMachinePanel();
            updateStatistics();
            closeEndTaskModal();
            
            alert(`${endingTaskType === 'production' ? '生产' : '试模'}任务已结束！`);
        }
        
        // 关闭结束任务模态框
        function closeEndTaskModal() {
            document.getElementById('end-task-modal').style.display = 'none';
            endingTaskId = null;
            endingTaskType = null;
        }
        
        // 编辑任务 - 完全重写的修复版本
        function editTask(taskId, taskType) {
            console.log('开始编辑任务:', taskId, taskType); // 调试信息
            
            const task = tasks.find(t => t.id === parseInt(taskId));
            if (task) {
                console.log('找到任务:', task); // 调试信息
                
                if (taskType === 'production') {
                    // 切换到生产任务标签页
                    switchTab('production');
                    
                    // 填充表单数据
                    fillFormWithTask(task);
                    
                    // 显示更新按钮，隐藏添加按钮
                    document.getElementById('add-task-btn').style.display = 'none';
                    document.getElementById('update-task-btn').style.display = 'inline-block';
                    
                    // 设置当前编辑的任务ID
                    editingTaskId = task.id;
                    
                    // 滚动到表单区域
                    setTimeout(() => {
                        document.getElementById('production-tab').scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                    
                    console.log('生产任务表单已填充'); // 调试信息
                } else {
                    // 切换到试模任务标签页
                    switchTab('trial');
                    
                    // 填充表单数据
                    fillTrialFormWithTask(task);
                    
                    // 显示更新按钮，隐藏添加按钮
                    document.getElementById('add-trial-btn').style.display = 'none';
                    document.getElementById('update-trial-btn').style.display = 'inline-block';
                    
                    // 设置当前编辑的任务ID
                    editingTaskId = task.id;
                    
                    // 滚动到表单区域
                    setTimeout(() => {
                        document.getElementById('trial-tab').scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                    
                    console.log('试模任务表单已填充'); // 调试信息
                }
            } else {
                console.error('未找到任务:', taskId); // 调试信息
                alert('未找到要编辑的任务');
            }
        }
        
        // 删除任务
        function deleteTask(taskId) {
            if (!confirm('确定要删除这个任务吗？')) {
                return;
            }
            
            const taskIndex = tasks.findIndex(t => t.id === parseInt(taskId));
            if (taskIndex === -1) return;
            
            const task = tasks[taskIndex];
            
            // 释放机台
            const machine = machines.find(m => m.id === task.machineId);
            machine.status = 'idle';
            machine.currentTask = null;
            
            // 删除任务
            tasks.splice(taskIndex, 1);
            
            saveData();
            renderTasksTable();
            renderMachinePanel();
            updateStatistics();
            
            if (editingTaskId === parseInt(taskId)) {
                if (currentTab === 'production') {
                    resetForm();
                } else {
                    resetTrialForm();
                }
            }
            
            alert('任务删除成功！');
        }
        
        // 打开更新进度模态框
        function openProgressModal(taskId, taskType) {
            const task = tasks.find(t => t.id === parseInt(taskId));
            if (task) {
                progressUpdateTaskId = task.id; // 使用任务ID
                document.getElementById('completed-qty').value = task.completedQty;
                
                // 根据任务类型设置状态选项
                const statusSelect = document.getElementById('machine-status');
                statusSelect.innerHTML = '';
                
                if (taskType === 'production') {
                    statusSelect.innerHTML = `
                        <option value="running">生产中</option>
                        <option value="paused">已暂停</option>
                        <option value="idle">空闲</option>
                        <option value="warning">待机</option>
                        <option value="error">故障</option>
                    `;
                } else {
                    statusSelect.innerHTML = `
                        <option value="trial">试模中</option>
                        <option value="idle">空闲</option>
                        <option value="warning">待机</option>
                        <option value="error">故障</option>
                    `;
                }
                
                statusSelect.value = task.status;
                document.getElementById('update-progress-modal').style.display = 'flex';
            }
        }
        
        // 关闭更新进度模态框
        function closeProgressModal() {
            document.getElementById('update-progress-modal').style.display = 'none';
            progressUpdateTaskId = null;
        }
        
        // 保存进度
        function saveProgress() {
            const completedQty = parseInt(document.getElementById('completed-qty').value);
            const status = document.getElementById('machine-status').value;
            
            if (isNaN(completedQty) || completedQty < 0) {
                alert('请输入有效的完成数量');
                return;
            }
            
            const taskIndex = tasks.findIndex(t => t.id === progressUpdateTaskId);
            if (taskIndex === -1) return;
            
            // 更新任务
            tasks[taskIndex].completedQty = completedQty;
            tasks[taskIndex].status = status;
            tasks[taskIndex].manuallyUpdated = true; // 标记为手动更新
            
            // 更新机台状态
            const machine = machines.find(m => m.id === tasks[taskIndex].machineId);
            machine.status = status;
            
            saveData();
            renderTasksTable();
            renderMachinePanel();
            updateStatistics();
            closeProgressModal();
            
            alert('进度更新成功！');
        }
        
        // 打开编辑机台模态框
        function openEditMachineModal(machineId) {
            const machine = machines.find(m => m.id === machineId);
            if (machine) {
                editingMachineId = machineId;
                document.getElementById('edit-machine-name').value = machine.name;
                document.getElementById('edit-machine-brand').value = machine.brand || '';
                document.getElementById('edit-machine-tonnage').value = machine.tonnage || '';
                document.getElementById('edit-machine-mold-size').value = machine.moldSize || '';
                document.getElementById('edit-machine-shot-weight').value = machine.shotWeight || '';
                document.getElementById('edit-machine-status').value = machine.status;
                document.getElementById('edit-machine-remark').value = machine.remark || '';
                document.getElementById('edit-machine-modal').style.display = 'flex';
            }
        }
        
        // 关闭编辑机台模态框
        function closeEditMachineModal() {
            document.getElementById('edit-machine-modal').style.display = 'none';
            editingMachineId = null;
        }
        
        // 保存机台信息
        function saveMachine() {
            if (!editingMachineId) return;
            
            const machineIndex = machines.findIndex(m => m.id === editingMachineId);
            if (machineIndex === -1) return;
            
            const name = document.getElementById('edit-machine-name').value;
            const brand = document.getElementById('edit-machine-brand').value;
            const tonnage = parseInt(document.getElementById('edit-machine-tonnage').value);
            const moldSize = document.getElementById('edit-machine-mold-size').value;
            const shotWeight = parseInt(document.getElementById('edit-machine-shot-weight').value);
            const status = document.getElementById('edit-machine-status').value;
            const remark = document.getElementById('edit-machine-remark').value;
            
            if (!name) {
                alert('请输入机台名称');
                return;
            }
            
            machines[machineIndex].name = name;
            machines[machineIndex].brand = brand;
            machines[machineIndex].tonnage = tonnage;
            machines[machineIndex].moldSize = moldSize;
            machines[machineIndex].shotWeight = shotWeight;
            machines[machineIndex].status = status;
            machines[machineIndex].remark = remark;
            
            saveData();
            renderMachinePanel();
            renderMachineOptions();
            updateStatistics();
            closeEditMachineModal();
            
            alert('机台信息更新成功！');
        }
        
        // 删除机台
        function deleteMachine() {
            if (!editingMachineId) return;
            
            if (!confirm('确定要删除这个机台吗？此操作不可撤销。')) {
                return;
            }
            
            const machineIndex = machines.findIndex(m => m.id === editingMachineId);
            if (machineIndex === -1) return;
            
            // 检查机台是否有任务
            if (machines[machineIndex].currentTask) {
                alert('该机台有正在执行的任务，无法删除');
                return;
            }
            
            machines.splice(machineIndex, 1);
            
            saveData();
            renderMachinePanel();
            renderMachineOptions();
            updateStatistics();
            closeEditMachineModal();
            
            alert('机台删除成功！');
        }
        
        // 打开新增机台模态框
        function openAddMachineModal() {
            // 检查机台数量是否已达上限
            if (machines.length >= 30) {
                alert('机台数量已达上限（30台），无法新增');
                return;
            }
            
            document.getElementById('add-machine-modal').style.display = 'flex';
        }
        
        // 关闭新增机台模态框
        function closeAddMachineModal() {
            document.getElementById('add-machine-modal').style.display = 'none';
        }
        
        // 保存新机台
        function saveNewMachine() {
            const name = document.getElementById('new-machine-name').value;
            const brand = document.getElementById('new-machine-brand').value;
            const tonnage = parseInt(document.getElementById('new-machine-tonnage').value);
            const moldSize = document.getElementById('new-machine-mold-size').value;
            const shotWeight = parseInt(document.getElementById('new-machine-shot-weight').value);
            const remark = document.getElementById('new-machine-remark').value;
            
            if (!name) {
                alert('请输入机台名称');
                return;
            }
            
            // 生成新机台ID
            const newId = machines.length > 0 ? Math.max(...machines.map(m => m.id)) + 1 : 1;
            
            machines.push({
                id: newId,
                name: name,
                brand: brand,
                tonnage: tonnage,
                moldSize: moldSize,
                shotWeight: shotWeight,
                status: 'idle',
                currentTask: null,
                history: [],
                remark: remark
            });
            
            saveData();
            renderMachinePanel();
            renderMachineOptions();
            updateStatistics();
            closeAddMachineModal();
            
            alert('机台添加成功！');
        }
        
        // 重置生产任务表单
        function resetForm() {
            document.getElementById('task-form').reset();
            document.getElementById('add-task-btn').style.display = 'inline-block';
            document.getElementById('update-task-btn').style.display = 'none';
            editingTaskId = null;
            
            // 设置默认开始时间为当前时间
            const now = new Date();
            document.getElementById('start-time').value = formatDateTimeInput(now);
            
            // 自动计算需生产数量
            calculateRequiredQty();
        }
        
        // 重置试模任务表单
        function resetTrialForm() {
            document.getElementById('trial-form').reset();
            document.getElementById('add-trial-btn').style.display = 'inline-block';
            document.getElementById('update-trial-btn').style.display = 'none';
            editingTaskId = null;
            
            // 设置默认开始时间为当前时间
            const now = new Date();
            document.getElementById('trial-start-time').value = formatDateTimeInput(now);
        }
        
        // 获取生产任务表单数据
        function getFormData() {
            return {
                machineId: parseInt(document.getElementById('machine-id').value),
                moldNo: document.getElementById('mold-no').value,
                cycleTime: parseInt(document.getElementById('cycle-time').value),
                orderQty: parseInt(document.getElementById('order-qty').value),
                stockQty: parseInt(document.getElementById('stock-qty').value),
                requiredQty: parseInt(document.getElementById('required-qty').value),
                startTime: new Date(document.getElementById('start-time').value).toISOString(),
                color: document.getElementById('color').value,
                productionMethod: document.getElementById('production-method').value,
                remark: document.getElementById('remark').value
            };
        }
        
        // 获取试模任务表单数据
        function getTrialFormData() {
            return {
                machineId: parseInt(document.getElementById('trial-machine-id').value),
                trialMoldNo: document.getElementById('trial-mold-no').value,
                customerMoldNo: document.getElementById('customer-mold-no').value,
                trialColor: document.getElementById('trial-color').value,
                material: document.getElementById('material').value,
                trialQty: parseInt(document.getElementById('trial-qty').value),
                applicant: document.getElementById('applicant').value,
                trialStartTime: new Date(document.getElementById('trial-start-time').value).toISOString(),
                trialRemark: document.getElementById('trial-remark').value
            };
        }
        
        // 验证生产任务表单
        function validateForm(formData) {
            if (!formData.machineId) {
                alert('请选择机台');
                return false;
            }
            
            if (!formData.moldNo) {
                alert('请输入模具编号');
                return false;
            }
            
            if (!formData.cycleTime || formData.cycleTime <= 0) {
                alert('请输入有效的生产周期');
                return false;
            }
            
            if (!formData.orderQty || formData.orderQty <= 0) {
                alert('请输入有效的订单数量');
                return false;
            }
            
            if (formData.stockQty < 0) {
                alert('库存数量不能为负数');
                return false;
            }
            
            if (!formData.requiredQty || formData.requiredQty <= 0) {
                alert('需生产数量必须大于0');
                return false;
            }
            
            if (!formData.startTime) {
                alert('请选择开始时间');
                return false;
            }
            
            return true;
        }
        
        // 验证试模任务表单
        function validateTrialForm(formData) {
            if (!formData.machineId) {
                alert('请选择机台');
                return false;
            }
            
            if (!formData.trialMoldNo) {
                alert('请输入模号');
                return false;
            }
            
            if (!formData.customerMoldNo) {
                alert('请输入客户模号');
                return false;
            }
            
            if (!formData.material) {
                alert('请输入胶料');
                return false;
            }
            
            if (!formData.trialQty || formData.trialQty <= 0) {
                alert('请输入有效的试模数量');
                return false;
            }
            
            if (!formData.applicant) {
                alert('请输入申请人');
                return false;
            }
            
            if (!formData.trialStartTime) {
                alert('请选择开始时间');
                return false;
            }
            
            return true;
        }
        
        // 计算需生产数量
        function calculateRequiredQty() {
            const orderQty = parseInt(document.getElementById('order-qty').value) || 0;
            const stockQty = parseInt(document.getElementById('stock-qty').value) || 0;
            const requiredQty = Math.max(0, orderQty - stockQty);
            document.getElementById('required-qty').value = requiredQty;
        }
        
        // 获取状态文本
        function getStatusText(status) {
            switch (status) {
                case 'idle': return '空闲';
                case 'running': return '生产中';
                case 'paused': return '已暂停';
                case 'trial': return '试模中';
                case 'warning': return '待机';
                case 'error': return '故障';
                case 'completed': return '已完成';
                default: return '未知';
            }
        }
        
        // 获取状态类名
        function getStatusClass(status) {
            switch (status) {
                case 'idle': return 'status-idle';
                case 'running': return 'status-running';
                case 'paused': return 'status-paused';
                case 'trial': return 'status-warning';
                case 'warning': return 'status-warning';
                case 'error': return 'status-error';
                case 'completed': return 'status-running'; // 已完成也用绿色
                default: return 'status-idle';
            }
        }
        
        // 格式化日期时间（显示用）
        function formatDateTime(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        
        // 格式化日期时间（输入框用）
        function formatDateTimeInput(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // 导出Excel
        function exportToExcel() {
            // 准备数据
            const data = [];
            
            // 添加表头
            data.push([
                '机台名称', '品牌', '吨位数', '容模尺寸', '熔胶量', '任务类型', 
                '模具/模号', '客户模号', '开始时间', '结束时间', 
                '目标数量', '完成数量', '超产数量', '总时长(小时)', '状态'
            ]);
            
            // 添加机台历史数据
            machines.forEach(machine => {
                machine.history.forEach(record => {
                    const startTime = new Date(record.startTime);
                    const endTime = new Date(record.endTime);
                    const duration = (endTime - startTime) / (1000 * 60 * 60); // 转换为小时
                    
                    let completedQty = record.completedQty || 0;
                    let requiredQty = record.requiredQty || record.trialQty || 0;
                    let excessQty = record.excessQty || (completedQty > requiredQty ? completedQty - requiredQty : 0);
                    
                    data.push([
                        machine.name,
                        machine.brand,
                        machine.tonnage,
                        machine.moldSize,
                        machine.shotWeight,
                        record.type === 'production' ? '生产' : '试模',
                        record.moldNo || record.trialMoldNo,
                        record.customerMoldNo || '',
                        formatDateTime(startTime),
                        formatDateTime(endTime),
                        requiredQty,
                        completedQty,
                        excessQty,
                        duration.toFixed(2),
                        '已完成'
                    ]);
                });
                
                // 添加当前任务
                if (machine.currentTask) {
                    const task = tasks.find(t => t.id === machine.currentTask);
                    if (task) {
                        const startTime = new Date(task.startTime);
                        const currentTime = new Date();
                        const duration = (currentTime - startTime) / (1000 * 60 * 60); // 转换为小时
                        
                        let completedQty = task.completedQty || 0;
                        let requiredQty = task.requiredQty || task.trialQty || 0;
                        let excessQty = completedQty > requiredQty ? completedQty - requiredQty : 0;
                        
                        data.push([
                            machine.name,
                            machine.brand,
                            machine.tonnage,
                            machine.moldSize,
                            machine.shotWeight,
                            task.type === 'production' ? '生产' : '试模',
                            task.moldNo || task.trialMoldNo,
                            task.customerMoldNo || '',
                            formatDateTime(startTime),
                            task.completedAt ? formatDateTime(new Date(task.completedAt)) : '进行中',
                            requiredQty,
                            completedQty,
                            excessQty,
                            duration.toFixed(2),
                            getStatusText(task.status)
                        ]);
                    }
                }
            });
            
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // 设置列宽
            const colWidths = [
                {wch: 15}, // 机台名称
                {wch: 10}, // 品牌
                {wch: 10}, // 吨位数
                {wch: 15}, // 容模尺寸
                {wch: 10}, // 熔胶量
                {wch: 10}, // 任务类型
                {wch: 15}, // 模具/模号
                {wch: 15}, // 客户模号
                {wch: 20}, // 开始时间
                {wch: 20}, // 结束时间
                {wch: 12}, // 目标数量
                {wch: 12}, // 完成数量
                {wch: 12}, // 超产数量
                {wch: 15}, // 总时长
                {wch: 10}  // 状态
            ];
            ws['!cols'] = colWidths;
            
            // 添加工作表到工作簿
            XLSX.utils.book_append_sheet(wb, ws, '机台使用统计');
            
            // 生成Excel文件并下载
            const fileName = `注塑机台使用统计_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            alert('Excel报表导出成功！');
        }
        
        // 初始化应用
        init();
    </script>
</body>
</html>